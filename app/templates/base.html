<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">

<head>

    {{template "style"}}
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    <title>index</title>
</head>

<body>
    {{template "header"}}
    <div id="main">
        <h1>[[ tableLen ]]</h1>
        <h3>[[ parentPaths[parentPaths.length - 1] ]]</h3>
        <el-button type="primary" @click="up">Up</el-button>
        <el-table :data="tableData" style="width: 90%;margin-left: 100px;margin-right: 100px;margin-bottom: 50px">
            <el-table-column label="" width="50">
                <div slot-scope="scope">
                    <el-image style="width: 20px; height: 20px" :src="'/static'+scope.row.finalPath"
                        v-if="scope.row.image" :preview-src-list="generateArray(scope.row.finalPath)">
                    </el-image>
                    <el-image style="width: 20px; height: 20px" src="/logo/file.png" v-if="scope.row.fileType =='dir'">
                    </el-image>
                    <el-image style="width: 20px; height: 20px" src="/logo/pdf.png" v-if="scope.row.fileType=='pdf'">
                    </el-image>
                    <el-image style="width: 20px; height: 20px" src="/logo/code.png" v-if="scope.row.fileType=='code'">
                    </el-image>
                    <el-image style="width: 20px; height: 20px" src="/logo/code.png" v-if="scope.row.fileType=='text'">
                    </el-image>
                </div>
            </el-table-column>
            <el-table-column label="Path" width="550" sortable>
                <div slot-scope="scope">
                    <el-link icon="el-icon-picture-outline" :href="'/static'+scope.row.finalPath"
                        v-if="scope.row.image">
                        [[ scope.row.path ]]
                    </el-link>
                    <el-link icon="el-icon-folder-opened" @click="clickDir(scope.row)" id="dir"
                        v-if="scope.row.fileType =='dir'">
                        [[ scope.row.path ]]
                    </el-link>
                    <el-link icon="el-icon-document" id="file" :href="'/edit?pid='+scope.row.id"
                        v-if="scope.row.fileType != 'dir' && !scope.row.image">
                        [[ scope.row.path ]]
                    </el-link>
                </div>
            </el-table-column>

            <el-table-column prop="fileSize" label="Size" width="200" sortable>
                <div slot-scope="scope" id="info">
                    [[ formatterSize(scope.row.fileSize) ]]
                </div>
            </el-table-column>
            <el-table-column prop="share" label="Share" width="100" sortable>
                <div slot-scope="scope" id="info">
                    [[ formatterShare(scope.row.share) ]]
                </div>
            </el-table-column>
            <el-table-column prop="modTime" label="Last Modify Time" width="300" sortable>
                <div slot-scope="scope" id="info">
                    [[ scope.row.modTime ]]
                </div>
            </el-table-column>
        </el-table>
    </div>
</body>
{{template "js"}}
<script>
    var app = new Vue({
        delimiters: ['[[ ', ' ]]'],
        el: '#app',
        data: {
            activeIndex: '/'
        },
        methods: {

            handleSelect: function (key, keyPath) {
                if (key === '#' || key === '/') {
                    this.activeIndex = '/';
                    window.location.href = '/'
                }
                if (key === 'search') {
                    this.activeIndex = "search"
                    window.location.href = "search"
                }
            }
        },
        created: function () {
        }
    })
</script>
<script>
    var main = new Vue({
        el: '#main',
        delimiters: ['[[ ', ' ]]'],
        data: {
            activeIndex: '/',
            paths: [],
            tableData: [],
            tableLen: 0,
            pid: [],
            parentPaths: [],
        },
        methods: {
            up: function () {
                if (this.pid.length == 0) {
                    this.getPaths(-1)
                    return
                }
                this.getPaths(this.pid.pop())
                this.parentPaths.pop()

            },
            generateArray: function (p) {
                return ["/static" + p]
            },
            formatterShare: function (share) {
                if (share == 0) {
                    return "专用"
                } else return "公开"
            },
            formatterSize: function (size) {
                if (size == 0) {
                    return "-"
                }
                if (size > 1024) {
                    return (size / 1024).toFixed(2) + " KB"
                }
            },
            clickDir: function (t) {
                this.pid.push(t.parentId)
                this.parentPaths.push(t.parentDir)
                this.getPaths(t.id)
            },
            getPaths: function (p) {
                _t = this
                axios
                    .get('/files?p=' + p)
                    .then(function (response) {
                        _t.tableData = []
                        d = response.data.f
                        _t.tableLen = d.length
                        for (i = 0; i < d.length; i++) {
                            _t.tableData.push({
                                "id": d[i].Id,
                                "type": d[i].Type,
                                "path": d[i].Path,
                                "parentDir": d[i].ParentDir,
                                "parentId": d[i].ParentId,
                                "fileSize": d[i].FileSize,
                                "share": d[i].Share,
                                "modTime": d[i].ModTime,
                                "fileType": d[i].FileType,
                                "finalPath": d[i].ParentDir + d[i].Path,
                                "image": d[i].Image
                            })
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            },
        },
        created: function () {
            this.getPaths(-1)

        }
    })
</script>

</html>